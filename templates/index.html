<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• HotLeads üî•</title>

    <style>
        /* –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Ç–µ–º—ã */
        body {
            transition: background-color 0.3s, color 0.3s;
        }
    </style>

    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã –≤ localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.write(`<link rel="stylesheet" href="${savedTheme}" id="theme-style">`);
        } else {
            document.write(`<link rel="stylesheet" href="{{ url_for('static', filename=current_theme) }}" id="theme-style">`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        function toggleCommentSize(element) {
            element.classList.toggle("expanded");
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<h1 class="hotleads-title">
    <a style="text-decoration: none; color: inherit;">üî• HotLeads üî•</a>
</h1>

<!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ -->
<div class="popup-overlay" id="popup-overlay"></div>
<div class="popup" id="popup">
    <div class="popup-content" id="popup-content"></div>

</div>

<div class="header-container">
    {% if session.manager_name %}
    <span class="welcome-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ session.manager_name }}!</span>
    <a href="{{ url_for('logout') }}" class="logout-button">–í—ã–π—Ç–∏</a>
    <span class="theme-switcher" id="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåö</span>
    {% endif %}
</div>

<form method="GET" action="{{ url_for('index') }}">
    <input type="hidden" name="current_theme" id="current-theme" value="{{ current_theme }}">

    {% if is_admin %}
    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
    <select name="manager" id="manager" onchange="this.form.submit()">
        <option value="">–í—Å–µ</option>
        {% for manager in managers %}
        <option value="{{ manager[0] }}" {% if manager[0]== selected_manager %}selected{% endif %}>{{ manager[0] }}
        </option>
        {% endfor %}
    </select>
    {% endif %}

    <label>–ü—Ä–æ–µ–∫—Ç:</label>
    <select name="project" id="project" onchange="this.form.submit()">
        <option value="">–í—Å–µ</option>
        {% for project in projects %}
        <option value="{{ project[0] }}" {% if project[0]== selected_project %}selected{% endif %}>{{ project[0] }}
        </option>
        {% endfor %}
    </select>
</form>

<table>
    <thead>
    <tr>
        <th>–ó–≤–æ–Ω–æ–∫</th>
        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
        <th>–ò–º—è</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        <th>GPT</th>
    </tr>
    </thead>
    <tbody>
    {% for call in calls %}
    <tr id="call-{{ call[0] }}" data-id="{{ call[0] }}" class="{% if call[-2] %}duplicate-phone{% endif %}">
        <td>
            <div class="custom-audio-player" id="player-{{ call[0] }}">
                <button class="play-btn" onclick="togglePlay('{{ call[0] }}')">‚ñ∂Ô∏è</button>
                <button class="pause-btn" style="display: none;" onclick="togglePlay('{{ call[0] }}')">‚è∏Ô∏è</button>
                <div class="progress-container" onclick="setProgress(event, '{{ call[0] }}')">
                    <div class="progress-bar"></div>
                </div>
                <div class="time-display">
                    <span class="current-time" id="current-time-{{ call[0] }}">00:00</span> /
                    <span class="duration" id="duration-{{ call[0] }}">00:00</span>
                </div>
                <select class="speed-selector" id="speed-{{ call[0] }}" onchange="setPlaybackRate('{{ call[0] }}')">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
                <audio id="audio-{{ call[0] }}" src="{{ call[14] }}" preload="none"></audio>
            </div>
        </td>

        <td>{{ call[9] }}</td>
        <td><textarea class="editable" data-field="comment">{{ call[8] }}</textarea></td>
        <td><textarea class="editable" data-field="name">{{ call[6] }}</textarea></td>
        <td>
            <div class="button-container">
                <button type="button" class="save-button" onclick="saveRow({{ call[0] }})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="tables-button" onclick="sendRow({{ call[0] }})">–í —Ç–∞–±–ª–∏—Ü—É</button>
                {% if call[9] in duplicates %}
                <button type="button" class="delete-button" onclick="deleteRow({{ call[0] }})">–£–¥–∞–ª–∏—Ç—å</button>
                {% endif %}
                <button type="button" class="approve-btn" onclick="approveRow({{ call[0] }})">–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å</button>
            </div>
        </td>
        <td>

            <span class="question-icon" onclick="openCommentPopup('{{ call[10] }}')">üîÆ</span>
        </td>

    </tr>
    {% endfor %}
    </tbody>
</table>
</tbody>
</table>

<script>

    function openCommentPopup(commentText) {
     // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
     const displayText = commentText ? commentText : "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
     showPopup(displayText);
     }

     function showPopup(commentText) {
         // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –æ—Ç –ò–ò
         document.getElementById('popup-content').innerText = commentText;
         document.getElementById('popup').style.display = 'block';
         document.getElementById('popup-overlay').style.display = 'block';
     }

     // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
     function closePopup() {
         document.getElementById('popup').style.display = 'none';
         document.getElementById('popup-overlay').style.display = 'none';
     }

     // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
     document.getElementById('popup-overlay').addEventListener('click', closePopup);


     // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
     const themeToggle = document.getElementById('theme-toggle');
     const themeStyle = document.getElementById('theme-style');

     themeToggle.addEventListener('click', function() {
         const currentTheme = themeStyle.getAttribute('href');

         if (currentTheme.includes('white_styles.css')) {
             themeStyle.setAttribute('href', "{{ url_for('static', filename='css/dark_styles.css') }}");
             themeToggle.innerHTML = '‚òÄÔ∏è';
             localStorage.setItem('theme', "{{ url_for('static', filename='css/dark_styles.css') }}");
         } else {
             themeStyle.setAttribute('href', "{{ url_for('static', filename='css/white_styles.css') }}");
             themeToggle.innerHTML = 'üåô';
             localStorage.setItem('theme', "{{ url_for('static', filename='css/white_styles.css') }}");
         }
         document.getElementById('current-theme').value = themeStyle.getAttribute('href');
     });

     const duplicates = {{ duplicates | tojson }};

     function checkDuplicates() {
         const rows = document.querySelectorAll('tbody tr');
         rows.forEach(row => {
             const phone = row.querySelector('td:nth-child(2)').innerText;
             if (duplicates.includes(phone)) {
                 row.classList.add('duplicate-phone');
             }
         });
     }

     document.addEventListener('DOMContentLoaded', function() {
         checkDuplicates();
     });

     function saveRow(callId) {
         const customerName = document.querySelector(`#call-${callId} [data-field="name"]`).value;
         const comment = document.querySelector(`#call-${callId} [data-field="comment"]`).value;

         $.ajax({
             type: 'POST',
             url: '/save_lead',
             data: JSON.stringify({
                 id: callId,
                 name_note: customerName,
                 note: comment
             }),
             contentType: 'application/json'
         }).done(function(response) {
             if (response.status === "success") {
                 alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
             } else {
                 alert("–û—à–∏–±–∫–∞: " + response.message);
             }
         }).fail(function(xhr) {
             alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + xhr.responseText);
         });
     }

     function sendRow(callId) {
         $.ajax({
             type: 'POST',
             url: `/send/${callId}`,
             data: JSON.stringify({ id: callId }),
             contentType: 'application/json'
         }).done(function(response) {
             if (response.status === "success") {
                 location.reload();  // –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                 alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É!");


             } else {
                 alert("–û—à–∏–±–∫–∞: " + response.message);
             }
         }).fail(function(xhr) {
             alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: " + xhr.responseText);
         });
 }

     function deleteRow(callId) {
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫?")) {
        return;
    }

    $.ajax({
        type: 'DELETE',
        url: `/delete/${callId}`,
        contentType: 'application/json'
    }).done(function(response) {
        if (response.status === "success") {
            const callElement = document.getElementById(`call-${callId}`);
            if (callElement) {
                callElement.remove();
            }
            location.reload();  // –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            alert("–ó–≤–æ–Ω–æ–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!");

        } else {
            alert("–û—à–∏–±–∫–∞: " + response.message);
        }
    }).fail(function(xhr) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞: " + xhr.responseText);
    });
}

     function approveRow(callId) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫?")) {
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/approve',
            data: JSON.stringify({ id: callId }),
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                location.reload();  // –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                alert("–ó–≤–æ–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞: " + xhr.responseText);
        });
    }

     function togglePlay(callId) {
         const audio = document.getElementById(`audio-${callId}`);
         const playBtn = document.querySelector(`#player-${callId} .play-btn`);
         const pauseBtn = document.querySelector(`#player-${callId} .pause-btn`);

         if (audio.paused) {
             audio.play();
             playBtn.style.display = 'none';
             pauseBtn.style.display = 'inline-block';
         } else {
             audio.pause();
             playBtn.style.display = 'inline-block';
             pauseBtn.style.display = 'none';
         }
     }

     function setProgress(event, callId) {
         const progressBar = document.querySelector(`#player-${callId} .progress-bar`);
         const progressContainer = document.querySelector(`#player-${callId} .progress-container`);
         const audio = document.getElementById(`audio-${callId}`);
         const offsetX = event.offsetX;
         const width = progressContainer.offsetWidth;
         const percentage = offsetX / width;
         const progress = percentage * audio.duration;
         audio.currentTime = progress;
         progressBar.style.width = (percentage * 100) + '%';
     }

     function setPlaybackRate(callId) {
         const audio = document.getElementById(`audio-${callId}`);
         const speed = document.getElementById(`speed-${callId}`).value;
         audio.playbackRate = parseFloat(speed);
     }


</script>

</body>
</html>
