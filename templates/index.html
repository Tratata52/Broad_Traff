<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• HotLeads üî•</title>

    <style>
        /* –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å, –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å */
        body {
            transition: background-color 0.3s, color 0.3s; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è —Ñ–æ–Ω–∞ –∏ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ */
        }
    </style>

    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ç–µ–º–∞ –≤ localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            document.write(`<link rel="stylesheet" href="${savedTheme}" id="theme-style">`);
        } else {
            // –ï—Å–ª–∏ —Ç–µ–º—ã –Ω–µ—Ç, –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç–∏–ª—å
            document.write(`<link rel="stylesheet" href="{{ url_for('static', filename=current_theme) }}" id="theme-style">`);
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
        .theme-switcher {
            cursor: pointer;
            font-size: 24px;
            margin-left: 10px;
        }
    </style>
</head>

<body>
<h1 class="hotleads-title">
    <a href="http://127.0.0.1:5000/" style="text-decoration: none; color: inherit;">üî• HotLeads üî•</a>
</h1>


<div class="header-container">
    {% if session.manager_name %}
    <span class="welcome-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ session.manager_name }}!</span>

    <a href="{{ url_for('logout') }}" class="logout-button">–í—ã–π—Ç–∏</a>
    <span class="theme-switcher" id="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåö</span>

    {% endif %}
</div>

<form method="GET" action="{{ url_for('index') }}">
    <input type="hidden" name="current_theme" id="current-theme" value="{{ current_theme }}">

    {% if is_admin %}
    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
    <select name="manager" id="manager" onchange="this.form.submit()">
        <option value="">–í—Å–µ</option>
        {% for manager in managers %}
        <option value="{{ manager[0] }}" {% if manager[0]== selected_manager %}selected{% endif %}>
            {{ manager[0] }}
        </option>
        {% endfor %}
    </select>
    {% endif %}

    <label>–ü—Ä–æ–µ–∫—Ç:</label>
    <select name="project" id="project" onchange="this.form.submit()">
        <option value="">–í—Å–µ</option>
        {% for project in projects %}
        <option value="{{ project[0] }}" {% if project[0]== selected_project %}selected{% endif %}>
            {{ project[0] }}
        </option>
        {% endfor %}
    </select>

    <!--    <button type="submit">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>  &lt;!&ndash; –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ &ndash;&gt;-->
</form>

<table>
    <thead>
    <tr>
        <th>–ó–≤–æ–Ω–æ–∫</th>
        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
        <th>–ò–º—è</th>
        <th>–ì–æ—Ä–æ–¥</th>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    </thead>
    <tbody>
    {% for call in calls %}
    <tr id="call-{{ call[0] }}" data-id="{{ call[0] }}" class="{% if call[-2] %}duplicate-phone{% endif %}">
        <td>
            <div class="custom-audio-player" id="player-{{ call[0] }}">
                <button class="play-btn" onclick="togglePlay('{{ call[0] }}')">‚ñ∂Ô∏è</button>
                <button class="pause-btn" style="display: none;" onclick="togglePlay('{{ call[0] }}')">‚è∏Ô∏è</button>
                <div class="progress-container" onclick="setProgress(event, '{{ call[0] }}')">
                    <div class="progress-bar"></div>
                </div>
                <div class="time-display">
                    <span class="current-time" id="current-time-{{ call[0] }}">00:00</span> /
                    <span class="duration" id="duration-{{ call[0] }}">00:00</span>
                </div>
                <select class="speed-selector" id="speed-{{ call[0] }}" onchange="setPlaybackRate('{{ call[0] }}')">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
                <audio id="audio-{{ call[0] }}" src="{{ call[14] }}" preload="none"></audio>
            </div>
        </td>

        <td>{{ call[9] }}</td>
        <td>{{ call[8] }}</td>
        <td><textarea class="editable" data-field="name">{{ call[6] }}</textarea></td>
        <td><textarea class="editable" data-field="city">{{ call[7] }}</textarea></td>
        <td><textarea class="editable" data-field="comment">{{ call[10] }}</textarea></td>
        <td>
            <button type="button" class="save-button" onclick="saveRow({{ call[0] }})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" class="tables-button" onclick="sendRow({{ call[0] }})">–í —Ç–∞–±–ª–∏—Ü—É</button>
            {% if call[9] in duplicates %}
            <button type="button" class="delete-button" onclick="deleteRow({{ call[0] }})">–£–¥–∞–ª–∏—Ç—å</button>
            {% endif %}
            <button type="button" class="approve-btn" onclick="approveRow({{ call[0] }})">–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å</button>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<script>

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    const themeToggle = document.getElementById('theme-toggle');
    const themeStyle = document.getElementById('theme-style');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–µ–º—ã
    themeToggle.addEventListener('click', function() {
        const currentTheme = themeStyle.getAttribute('href');

        if (currentTheme.includes('white_styles.css')) {
            themeStyle.setAttribute('href', "{{ url_for('static', filename='css/dark_styles.css') }}");
            themeToggle.innerHTML = '‚òÄÔ∏è'; // –≠–º–æ–¥–∑–∏ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã
            localStorage.setItem('theme', "{{ url_for('static', filename='css/dark_styles.css') }}"); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É
        } else {
            themeStyle.setAttribute('href', "{{ url_for('static', filename='css/white_styles.css') }}");
            themeToggle.innerHTML = 'üåô'; // –≠–º–æ–¥–∑–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            localStorage.setItem('theme', "{{ url_for('static', filename='css/white_styles.css') }}"); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã
        document.getElementById('current-theme').value = themeStyle.getAttribute('href');
    });

    const duplicates = {{ duplicates | tojson }};

    function checkDuplicates() {
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const phone = row.querySelector('td:nth-child(2)').innerText;
            if (duplicates.includes(phone)) {
                row.classList.add('duplicate-phone');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        checkDuplicates();
    });

    function saveRow(callId) {
        const customerName = document.querySelector(`#call-${callId} [data-field="name"]`).value;
        const city = document.querySelector(`#call-${callId} [data-field="city"]`).value;
        const comment = document.querySelector(`#call-${callId} [data-field="comment"]`).value;

        $.ajax({
            type: 'POST',
            url: '/save_lead',
            data: JSON.stringify({
                id: callId,
                name_note: customerName,
                city_note: city,
                note: comment
            }),
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + xhr.responseText);
        });
    }

    function sendRow(callId) {
        const customerNameField = document.querySelector(`#call-${callId} [data-field="name"]`);
        const cityField = document.querySelector(`#call-${callId} [data-field="city"]`);
        const commentField = document.querySelector(`#call-${callId} [data-field="comment"]`);

        if (!customerNameField || !cityField || !commentField) {
            alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –æ–¥–Ω–æ –∏–∑ –ø–æ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.");
            return;
        }

        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –∫–ª–∏–µ–Ω—Ç—É?")) {
                return;
            }

        const customerName = customerNameField.value;
        const city = cityField.value;
        const comment = commentField.value;

        $.ajax({
            type: 'POST',
            url: `/send/${callId}`, // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π URL
            data: JSON.stringify({
                name_note: customerName,
                city_note: city,
                note: comment
            }),
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: " + xhr.responseText);
        });
}

   function deleteRow(callId) {
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫?")) {
        return;
    }

    $.ajax({
        type: 'DELETE',
        url: `/delete/${callId}`,
        contentType: 'application/json'
    }).done(function(response) {
        if (response.status === "success") {
            const callElement = document.getElementById(`call-${callId}`);
            if (callElement) {
                callElement.remove();
            }
            alert("–ó–≤–æ–Ω–æ–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!");
        } else {
            alert("–û—à–∏–±–∫–∞: " + response.message);
        }
    }).fail(function(xhr) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞: " + xhr.responseText);
    });
}



    function approveRow(callId) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫?")) {
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/approve',
            data: JSON.stringify({ id: callId }),
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                alert("–ó–≤–æ–Ω–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞: " + xhr.responseText);
        });
    }

    function togglePlay(callId) {
        const audio = document.getElementById(`audio-${callId}`);
        const playBtn = document.querySelector(`#player-${callId} .play-btn`);
        const pauseBtn = document.querySelector(`#player-${callId} .pause-btn`);

        if (audio.paused) {
            audio.play();
            playBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
        } else {
            audio.pause();
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
        }

        audio.onloadedmetadata = function() {
            const durationDisplay = document.getElementById(`duration-${callId}`);
            durationDisplay.textContent = formatTime(audio.duration);
        };

        audio.ontimeupdate = function() {
            const currentTimeDisplay = document.getElementById(`current-time-${callId}`);
            const progressBar = document.querySelector(`#player-${callId} .progress-bar`);

            currentTimeDisplay.textContent = formatTime(audio.currentTime);
            progressBar.style.width = (audio.currentTime / audio.duration) * 100 + '%';
        };
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes < 10 ? '0' : ''}${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function setProgress(event, callId) {
        const progressContainer = event.currentTarget;
        const progressBar = progressContainer.querySelector('.progress-bar');
        const audio = document.getElementById(`audio-${callId}`);
        const newTime = (event.offsetX / progressContainer.clientWidth) * audio.duration;

        audio.currentTime = newTime;
        progressBar.style.width = (audio.currentTime / audio.duration) * 100 + '%';
    }

    function setPlaybackRate(callId) {
        const playbackRate = document.getElementById(`speed-${callId}`).value;
        const audio = document.getElementById(`audio-${callId}`);
        audio.playbackRate = playbackRate;
    }
</script>
</body>
</html>
