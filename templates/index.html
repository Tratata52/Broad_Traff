<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>üéÑHotLeadsüéÑ</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark_styles.css') }}" id="theme-style">

    <style>
        /* –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Ç–µ–º—ã */
        body {
            transition: background-color 0.3s, color 0.3s;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<h1 class="hotleads-title">
    <a style="text-decoration: none; color: inherit;">üéÑ HotLeads üéÑ</a>
    <div class="dropdown">
        <button class="dropdown-button" style="text-decoration: none; color: inherit;">–û—Ç—á—ë—Ç—ã</button>
        <div class="dropdown-content">
            <a href="{{ url_for('report') }}">–û—Ç—á–µ—Ç –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º</a>
            <a href="{{ url_for('report_projects') }}">–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</a>
            <a href="{{ url_for('defective_leads') }}">–û—Ç—á–µ—Ç –ø–æ –±—Ä–∞–∫—É</a>
        </div>
    </div>
    <a href="{{ url_for('leads_page') }}" style="text-decoration: none; color: inherit;">–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞</a>
    <a href="{{ url_for('calc_page') }}" style="text-decoration: none; color: inherit;">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ó–ü</a>
</h1>

<!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ -->
<div class="popup-overlay" id="popup-overlay"></div>
<div class="popup" id="popup">
    <div class="popup-content" id="popup-content"></div>
</div>

<div class="header-container">
    {% if session.manager_name %}
    <span class="welcome-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ session.manager_name }}!</span>
    <a class="logout-button" href="{{ url_for('logout') }}">–í—ã–π—Ç–∏</a>
    {% endif %}
</div>

<form action="{{ url_for('index') }}" method="GET">
    <input id="current-theme" name="current_theme" type="hidden" value="dark_styles.css">

    {% if is_admin %}
    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
    <select id="manager" name="manager" onchange="this.form.submit()">
        <option value="" {% if not selected_manager %}selected{% endif %}>–í—Å–µ</option>
        {% for manager in managers %}
        <option value="{{ manager[0] }}" {% if manager[0]== selected_manager %}selected{% endif %}>
            {{ manager[0] }}
        </option>
        {% endfor %}
    </select>
    {% endif %}

    <label>–ü—Ä–æ–µ–∫—Ç:</label>
    <select id="project" name="project" onchange="this.form.submit()">
        <option value="" {% if not selected_project %}selected{% endif %}>–í—Å–µ</option>
        {% for project in projects %}
        <option value="{{ project[0] }}" {% if project[0]== selected_project %}selected{% endif %}>
            {{ project[0] }}
        </option>
        {% endfor %}
    </select>
</form>

<table>
    <thead>
    <tr>
        <th>–ó–≤–æ–Ω–æ–∫</th>
        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
        <th>–ò–º—è</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        <th>GPT</th>
    </tr>
    </thead>
    <tbody>
    {% for call in calls %}
    <tr class="{% if call[-2] %}duplicate-phone{% endif %}" data-id="{{ call[0] }}" id="call-{{ call[0] }}">
        <td>
            <div class="custom-audio-player" id="player-{{ call[0] }}">
                <button class="play-btn" onclick="togglePlay('{{ call[0] }}')">‚ñ∂Ô∏è</button>
                <button class="pause-btn" onclick="togglePlay('{{ call[0] }}')" style="display: none;">‚è∏Ô∏è</button>
                <div class="progress-container" onclick="setProgress(event, '{{ call[0] }}')">
                    <div class="progress-bar"></div>
                </div>

                <select class="speed-selector" id="speed-{{ call[0] }}" onchange="setPlaybackRate('{{ call[0] }}')">
                    <option value="0.5">0.5x</option>
                    <option selected value="1">1x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
                <audio id="audio-{{ call[0] }}" preload="none" src="{{ call[14] }}"></audio>
            </div>
        </td>

        <td>{{ call[9] }}</td>
        <td><textarea class="editable" data-field="comment">{{ call[8] }}</textarea></td>
        <td><textarea class="editable" data-field="name">{{ call[6] }}</textarea></td>
        <td>
            <div class="button-container">
                <button class="save-button" onclick="saveRow({{ call[0] }})" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="tables-button" onclick="sendRow({{ call[0] }})" type="button">–í —Ç–∞–±–ª–∏—Ü—É</button>
                {% if call[9] in duplicates %}
                <button class="delete-button" onclick="deleteRow({{ call[0] }})" type="button">–£–¥–∞–ª–∏—Ç—å</button>
                {% endif %}
                <button class="approve-btn" onclick="approveRow({{ call[0] }})" type="button">–ë—Ä–∞–∫</button>
            </div>
        </td>
        <td>
            <span class="question-icon" onclick="openCommentPopup('{{ call[10] }}')">üîÆ</span>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<script>

    function openCommentPopup(commentText) {
        const displayText = commentText ? commentText : "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
        showPopup(displayText);
    }

    function showPopup(commentText) {
        document.getElementById('popup-content').innerText = commentText;
        document.getElementById('popup').style.display = 'block';
        document.getElementById('popup-overlay').style.display = 'block';
    }

    function closePopup() {
        document.getElementById('popup').style.display = 'none';
        document.getElementById('popup-overlay').style.display = 'none';
    }

    document.getElementById('popup-overlay').addEventListener('click', closePopup);

    const duplicates = {{ duplicates | tojson }};

    function checkDuplicates() {
        const rows = document.querySelectorAll('tbody tr');
        const phoneNumbers = Array.from(rows).map(row => row.querySelector('td:nth-child(2)').innerText);
        const duplicatePhones = phoneNumbers.filter(phone => duplicates.includes(phone));

        rows.forEach(row => {
            const phone = row.querySelector('td:nth-child(2)').innerText;
            if (duplicatePhones.includes(phone)) {
                row.classList.add('duplicate-phone');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        checkDuplicates();
    });

    function saveRow(callId) {
        const customerName = document.querySelector(`#call-${callId} [data-field="name"]`).value;
        const comment = document.querySelector(`#call-${callId} [data-field="comment"]`).value;

        $.ajax({
            type: 'POST',
            url: '/save_lead',
            data: JSON.stringify({
                id: callId,
                name_note: customerName,
                note: comment
            }),
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + xhr.responseText);
        });
    }

    function sendRow(callId) {
        $.ajax({
            type: 'POST',
            url: `/send/${callId}`,
            data: JSON.stringify({ id: callId }),
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                location.reload();
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: " + xhr.responseText);
        });
    }

    function deleteRow(callId) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫?")) {
            return;
        }

        $.ajax({
            type: 'DELETE',
            url: `/delete/${callId}`,
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                const callElement = document.getElementById(`call-${callId}`);
                if (callElement) {
                    callElement.remove();
                }
                location.reload();
                alert("–ó–≤–æ–Ω–æ–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞: " + xhr.responseText);
        });
    }

    function approveRow(callId) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–∞–∫–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ª–∏–¥?")) {
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/approve',
            data: JSON.stringify({ id: callId }),
            contentType: 'application/json'
        }).done(function(response) {
            if (response.status === "success") {
                location.reload();
                alert("–õ–∏–¥ –∑–∞–±—Ä–∞–∫–æ–≤–∞–Ω!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + response.message);
            }
        }).fail(function(xhr) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–∞–∫–æ–≤–∫–µ –ª–∏–¥–∞: " + xhr.responseText);
        });
    }

    function togglePlay(callId) {
        const audio = document.getElementById(`audio-${callId}`);
        const playBtn = document.querySelector(`#player-${callId} .play-btn`);
        const pauseBtn = document.querySelector(`#player-${callId} .pause-btn`);

        if (audio.paused) {
            audio.play();
            playBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
        } else {
            audio.pause();
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
        }
    }

    function setProgress(event, callId) {
        const progressBar = document.querySelector(`#player-${callId} .progress-bar`);
        const progressContainer = document.querySelector(`#player-${callId} .progress-container`);
        const audio = document.getElementById(`audio-${callId}`);
        const offsetX = event.offsetX;
        const width = progressContainer.offsetWidth;
        const percentage = offsetX / width;
        const progress = percentage * audio.duration;
        audio.currentTime = progress;
        progressBar.style.width = `${percentage * 100}%`;
    }

    function setPlaybackRate(callId) {
        const playbackRate = document.getElementById(`speed-${callId}`).value;
        const audio = document.getElementById(`audio-${callId}`);
        audio.playbackRate = parseFloat(playbackRate);
    }
</script>

</body>
</html>
